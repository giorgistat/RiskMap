% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/dsgm.R
\name{dsgm}
\alias{dsgm}
\title{Fitting of Doubly Stochastic Geostatistical Model (DSGM) for joint analysis of prevalence
and intensity of infection}
\usage{
dsgm(
  formula,
  data,
  time,
  mda_times,
  int_mat,
  penalty = NULL,
  drop_W = NULL,
  decay_W = NULL,
  crs = NULL,
  convert_to_crs = NULL,
  scale_to_km = TRUE,
  par0 = NULL,
  n_samples = 1000,
  n_warmup = 1000,
  n_chains = 1,
  adapt_delta = 0.8,
  max_treedepth = 10,
  return_samples = TRUE,
  messages = TRUE,
  start_pars = list(beta = NULL, k = NULL, rho = NULL, sigma2 = NULL, phi = NULL, alpha_W
    = NULL, gamma_W = NULL)
)
}
\arguments{
\item{formula}{A model formula with egg counts (EPG) as response and covariates for mean worm burden.
Example: \code{epg ~ elevation + rainfall + gp(x, y)} where epg is the egg count variable.
Zero values indicate uninfected individuals.}

\item{data}{A \code{data.frame} or \code{sf} object containing the dataset.}

\item{time}{A variable in \code{data} giving the survey times of observations (required).}

\item{mda_times}{A vector specifying the mass drug administration (MDA) times.}

\item{int_mat}{Intervention matrix specifying MDA timing and coverage; dimension \code{n * n_mda}.}

\item{penalty}{Optional list specifying penalty functions for regularization of MDA parameters.}

\item{drop_W}{Optional fixed value for the immediate worm burden reduction parameter (alpha_W).}

\item{decay_W}{Optional fixed value for the worm burden decay parameter (gamma_W).}

\item{crs}{Optional coordinate reference system (CRS) for spatial data.}

\item{convert_to_crs}{CRS to which spatial data should be converted.}

\item{scale_to_km}{Logical; whether to scale distances to kilometers (default: \code{TRUE}).}

\item{par0}{Optional list of initial parameter values.}

\item{n_samples}{Number of MCMC samples to draw from spatial process (default: 1000).}

\item{n_warmup}{Number of warmup/burnin iterations for STAN (default: 1000).}

\item{n_chains}{Number of MCMC chains for STAN (default: 1).}

\item{adapt_delta}{Target acceptance rate for STAN sampler (default: 0.8).}

\item{max_treedepth}{Maximum tree depth for STAN sampler (default: 10).}

\item{return_samples}{Logical; whether to return spatial process samples (default: \code{TRUE}).}

\item{messages}{Logical; whether to print messages (default: \code{TRUE}).}

\item{start_pars}{List of starting values for parameters including:
\itemize{
  \item beta: Covariate effects on log mean worm burden
  \item k: Negative binomial aggregation parameter
  \item rho: Egg detection rate per worm
  \item sigma2: Variance of the spatial process
  \item phi: Scale parameter of the spatial correlation
  \item alpha_W: Immediate worm burden reduction
  \item gamma_W: Worm burden decay rate
}}
}
\value{
A list containing:
\itemize{
  \item \code{prevalence_data}: Binary infection indicators (C > 0).
  \item \code{intensity_data}: Egg counts among positive individuals.
  \item \code{n_positive}: Number of egg-positive individuals per location.
  \item \code{D}: Covariate matrix.
  \item \code{coords}: Unique spatial coordinates.
  \item \code{mda_times}: MDA time points.
  \item \code{survey_times_data}: Survey times.
  \item \code{int_mat}: Intervention matrix.
  \item \code{ID_coords}: Spatial location indices.
  \item \code{fix_alpha_W}, \code{fix_gamma_W}: Fixed MDA parameters if specified.
  \item \code{formula}: Model formula.
  \item \code{model_params}: Estimated parameters for worm burden, detection, and spatial processes.
  \item \code{spatial_samples}: STAN spatial process samples if \code{return_samples = TRUE}.
  \item \code{family}: "zero_inflated_gamma" indicating joint model structure.
}
}
\description{
The function fits a joint prevalence-intensity model for STH using Monte Carlo maximum likelihood.
The model incorporates a mechanistic worm burden framework where MDA effects decay over time,
affecting both prevalence and intensity through their impact on mean worm burden.
Uses STAN for sampling the spatial process conditional on fixed parameters.

Spatial structure:
\itemize{
  \item \code{gp(x, y)} fits a spatial Gaussian process S(x).
  \item The spatial process affects mean worm burden: log(mu_W*) = D*beta + S(x)
}
}
\seealso{
\code{\link{dast}}
}
\author{
[Your name]
}
